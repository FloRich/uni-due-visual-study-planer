<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Compare Subjects</title>
    <link rel="stylesheet" href="compare-page.css"/>
    <link rel="stylesheet" href="../scripts/bootstrap/bootstrap.min.css"/>
    <script src="../scripts/app-local-storage.js"></script>
    <script type="text/javascript" src="compare-page.js"></script>
    <script src="subject_ratings.js"></script>
    <script src="d3.js"></script>
</head>
<body>
    <main>
        <div id="heatmap">
            <svg>
                <defs>
                    <pattern id="no_rating" x="0" y="0"  width="50" height="50">
                        <line x1="15" x2="35" y1="15" y2="35" class="cross-line"></line>
                        <line x1="35" x2="15" y1="15" y2="35" class="cross-line"></line>
                    </pattern>
                </defs>
            </svg>
        </div>
    </main>
    <nav id="side-menu">
        <div class="card">
            <div class="card-header">
                <h2>
                    Step 2: Compare
                </h2>
                <h4> Decide which subjects you want to take </h4>
            </div>
            <div class="card-body">
                <section id="sws">
                    <div id="amount_of_sws">
                    </div>
                </section>
                <div id="sws-legend">
                    <span>Legend:</span>
                    <div id="sws-legend-items">

                    </div>
                </div>
                <br/>
                <section id="removed_subjects">
                    <h6>Removed Subjects</h6>
                    <hr/>
                    <ul id="subject-selection">

                    </ul>
                </section>
            </div>
        </div>
    </nav>

    <script>
        // load selected courses

        function removeSubject(index) {
            let removed = selected_subjects.splice(index,1);
            removedSubjects.push(...removed);

            updateViz();
        }

        // save ratings by the subjects name
        subjects_dict = new Map();
        for (let subject of subjects) {
            subjects_dict.set(subject.name, subject);
        }
        console.log(subjects_dict);

        // add ratings to the subject if the exists.
        for (let sub of selected_subjects) {
            let rating = subjects_dict.get(sub.name);
            if (rating != undefined) {
                sub['rating'] = rating;
                console.log(sub)
            } else {
                sub['rating'] = {};
            }
        }

        // Labels of row and columns
        let myGroups = ['recommendation', 'understandability', 'fairness','support','material','interest','fun', 'node_effort'];
        let width_of_field = 50;
        let height_of_field = 50;
        let width_of_legend = 180;

        // set the dimensions and margins of the graph
        var margin = {top: 75, right: 30, bottom: 30, left: 500},
          width = width_of_field * myGroups.length,
          height = height_of_field * selected_subjects.length;

        // append the svg object to the body of the page
        var svg = d3.select("#heatmap").select('svg')
          .attr("width", width + margin.left + margin.right + width_of_legend)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        // Build color scale
        var myColor = d3.scaleLinear()
            .range(["#fffc85", "#4bb354"])
            .domain([0,100]);

        var linearGradient = svg.append("defs")
            .append("linearGradient")
            .attr("id", "linear-gradient")
            .attr("gradientTransform", "rotate(90)");

        linearGradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", myColor(100));

        linearGradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", myColor(0));

        svg = svg.data(selected_subjects);

        // Build X scales and axis:
        var x = d3.scaleBand()
          .range([ 0, width ])
          .domain(myGroups)
          .padding(0.01);


        svg.append("g")
          .attr("transform","rotate(0)", "translate(0," + height + ")")
          .call(d3.axisTop(x))
          .selectAll("text")
          .attr("y", 0)
          .attr("x", 5)
          .attr("dy", -5)
          .attr("transform", "rotate(-45)")
          .style("text-anchor", "start");

        // Contruct legend
        let legend = svg.append("g")
            .attr("class","legend-content")
            .attr("transform","translate("+(width+20)+","+ (height*0.1-15)+")");

        //Create triangle
        var symbolGenerator = d3.symbol()
            .type(d3.symbolTriangle)
            .size(64);

        var triangle = legend.append("g")
            .attr("transform","rotate(90) translate(2.5,0)")
            .attr("class", "triangle-pointer");
        triangle
            .append("path")
            .attr("d", symbolGenerator());

        triangle
            .append("text")
            .attr("transform","rotate(-90)")
            .attr("x",35)
            .attr("id","triangle-text")
            .style("font-size","10px")
            .attr("y",5)
            .text("");

        // Create scale"
        let legendScale = legend.append("g");
        legendScale.append("text")
            .style("font-size","15px")
            .text("100 %");
        legendScale.append("rect")
            .attr("x", 10)
            .attr("y",2.5)
            .attr("width", 20)
            .attr("height", height*0.8)
            .attr("fill", "url(#linear-gradient)");
        legendScale.append("text")
            .attr("x",5)
            .style("font-size","15px")
            .attr("y", height*0.8 + 20)
            .text("0 %");

        // Add explaination for X
        let legendNoRating = legend.append("g")
            .attr("class","x-explaination")
            .attr("transform","translate(0,+"+(height*0.8+20+15)+")");
        legendNoRating.append("rect")
            .attr("y",-25)
            .attr("transform","scale(0.5)")
            .attr("width", width_of_field)
            .attr("height",height_of_field)
            .attr("fill", "url(#no_rating)");
        legendNoRating.append("text")
            .style("font-size","15px")
            .attr("x", width_of_field * 0.5)
            .attr("y", 4)
            .text("No Rating");

        /**
         * Moves the triangle from the legend to the specified element and position
         * @param type the element to move on. One of "values", "x-explaination"
         * @param value
         */
        function moveTriangeToValue(type, value) {
            let x = 0;
            let y = 2.5;
            if (type === "values") {
                y = y +(1-value) * (height*0.8);

                d3.select("#triangle-text").text(Math.round(value*10000)/100+" %")
            } else if (type === "x-explanation") {
                y = (height*0.8+20+15);
                d3.select("#triangle-text").text("");
            }

            triangle
                .transition()
                .delay(300)
                .attr("transform", "rotate(90) translate("+y+","+x+")")
        }

        function drawHeatMap() {
            let flattened_data = [];

            for (let element of selected_subjects){
                for (let attrib of myGroups) {
                    flattened_data.push({
                        name: element.name,
                        type: attrib,
                        value: element.rating[""+attrib] || -1
                    })
                }
            };

            // update margins
            width = width_of_field * myGroups.length;
            height = height_of_field * selected_subjects.length;

            // delete labels and rectangles
            d3.selectAll('.heatmap-label')
                .remove();

            d3.selectAll('.cell').remove();

            // Build Y scales and axis:
            var y = d3.scaleBand()
                .range([ height, 0 ])
                .domain(flattened_data.map(d => {
                    return d.name
                }))
                .padding(0.0);


            // append labels
            svg.append("g")
                .attr("class","heatmap-label")
                .call(d3.axisLeft(y));

            // provide interaction on labels
            svg.selectAll(".heatmap-label text")
                .on("click", function(d) {
                    let index = selected_subjects.findIndex((subject) => (subject.name === d));
                    if (index >= 0) {
                        removeSubject(index);
                        console.log(selected_subjects);
                        drawHeatMap();
                    }
                });

            // append rect angles
            let rect = svg.selectAll("cell")
                .data(flattened_data, function (d) {
                })
                .enter()
                .append("rect")
                .attr("class", "cell")
                .attr("x", function (d) {
                    return x(d.type)
                })
                .attr("y", function (d) {
                    return y(d.name)
                })
                .attr("width", x.bandwidth())
                .attr("height", y.bandwidth())
                .style("fill", function (d) {
                    if (d.value === -1) {
                        return "url(#no_rating)"
                    }
                    return myColor(d.value)
                })
                .on("mouseover", function(d) {
                    if (d.value === -1) {
                        moveTriangeToValue("x-explanation",0);
                    }else {
                        moveTriangeToValue("values",d.value/100);
                    }
            })
        }

        drawHeatMap();
        drawSwsChart(selected_subjects);
        renderRemovedSubjects(removedSubjects);

      </script>
  </body>
</html>
