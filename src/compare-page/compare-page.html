<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Compare Subjects</title>
    <link rel="stylesheet" href="compare-page.css"/>
    <link rel="stylesheet" href="../scripts/bootstrap/bootstrap.min.css"/>
    <script src="../scripts/app-local-storage.js"></script>
    <script src="../data/subject_ratings.js"></script>
    <script src="scripts/timeoverlap-heatmap.class.js"></script>
    <script src="scripts/ratings-heatmap.class.js"></script>
    <script src="compare-page.js"></script>
    <script src="../scripts/d3.js"></script>
</head>
<body>
    <main>
        <svg id="heatmaps">
            <defs>
                <pattern id="no_rating" x="0" y="0"  width="50" height="50">
                    <line x1="7" x2="18" y1="7" y2="18" class="cross-line"></line>
                    <line x1="18" x2="7" y1="7" y2="18" class="cross-line"></line>
                </pattern>
            </defs>
            <g id="move-group">
                <g id="rating-map">
                </g>
                <g id="timeoverlap-matrix">
                </g>
            </g>
        </svg>
    </main>
    <nav id="side-menu">
        <div class="card">
            <div class="card-header">
                <h2>
                    Step 2: Compare
                </h2>
                <h4> Decide which subjects you want to take </h4>
            </div>
            <div class="card-body">
                <section id="sws">
                    <div id="amount_of_sws">
                    </div>
                </section>
                <div id="sws-legend">
                    <span>Legend:</span>
                    <div id="sws-legend-items">

                    </div>
                </div>
                <br/>
                <section id="removed_subjects">
                    <h6>Removed Subjects</h6>
                    <hr/>
                    <ul id="subject-selection">
                    </ul>
                </section>
            </div>
        </div>
    </nav>
    <div id="tooltip"></div>
    <script>

        setSvgHightToParentsWidth();

        // save ratings by the subjects name
        let subjects_dict = new Map();
        for (let subject of subjects) {
            subjects_dict.set(subject.name, subject);
        }

        // add ratings to the subject if it exists.
        for (let sub of selected_subjects) {
            let rating = subjects_dict.get(sub.name);
            if (rating !== undefined) {
                sub['rating'] = rating;
            } else {
                sub['rating'] = {};
            }
        }

        let width_of_field = 25;
        let height_of_field = 25;

        function showTimeTooltip(timeOverlap) {
            console.log(timeOverlap)
            let body = document.getElementsByTagName("body")[0];
            let mouse = d3.mouse(body);
            d3.select("#tooltip")
                .style("display","flex")
                .style("left", mouse[0]+10+"px")
                .style("top", mouse[1] + "px")
                .on("mouseover", function(d) {
                    d3.select(this).style("display","none")
                })
                .html(function() {
                    let html = "";

                    let subjects = ['subjectA', 'subjectB'];
                    let overlapedSubjects = ['with','from'];

                    for (let i = 0; i<2; i++) {
                        let subject = timeOverlap[subjects[i]];
                        let overlapSubject = overlapedSubjects[i]
                        let semester = (subject.hasOwnProperty("semester"))? subject.semester: "".concat( ...subject.semesters, " ");
                        let subjectHtml = `
                        <div class="timetable-tooltip-subject">
                        <h6>${subject.name}</h6><p>${semester}</p>`;


                        let overlaps ='<div class="time-entry-overlap">Overlaping';
                        for (let overlap of timeOverlap.overlaps) {
                            let entry = overlap[overlapSubject];
                            overlaps += `
                                <div class="time-entry">
                                    <span>Day: ${entry.day}</span>
                                    <span>Time: ${entry.time.from} to ${entry.time.to}</span>
                                    <span>Duration: ${(Object.keys(entry.duration).indexOf("from") < 0) ? entry.duration : entry.duration.from + " to " + entry.duration.to}</span>
                                </div>
                                `;
                        }

                        subjectHtml += overlaps + `</div><div class='time-entries'> All`;

                        for (let entry of subject.timetable) {
                            subjectHtml += `
                            <div class="time-entry">
                                <span>Day: ${entry.day}</span>
                                <span>Time: ${entry.time.from} to ${entry.time.to}</span>
                                <span>Duration: ${(Object.keys(entry.duration).indexOf("from") < 0) ? entry.duration : entry.duration.from + " to " + entry.duration.to}</span>
                             </div>
                        `
                        }
                        subjectHtml += "</div></div>";
                        html += subjectHtml;
                    }
                    return html;
                })

        }

        function drawTitles() {
            let ratingX = -margin.left/4;
            let ratingY = -20;

            let overlapWidth = document.getElementById('timeoverlap-content').getBoundingClientRect().width;
            let overlapheight = document.getElementById('timeoverlap-content').getBoundingClientRect().height;
            let contentDetailWidth = 300;

            d3.select('#rating-map').select("g")
                .append("text")
                .attr("transform", "translate("+ratingX+","+ratingY+")")
                .attr("class","map-header")
                .text("Ratings");

            d3.select('#timeoverlap-matrix')
                .append("text")
                .attr("transform", "translate("+overlapWidth+","+overlapheight/2+")")
                .attr("x",10)
                .attr("y", "0.5em")
                .style("text-anchor","start")
                .attr("class","map-header")
                .text("Time overlaps");

        }

        if (selected_subjects.length > 0) {
            // apply pen and zooming
            let zoom = d3.zoom()
                .on("zoom", () => {
                    console.log("zoom");
                    d3.select('#move-group').attr("transform", d3.event.transform)
                });
            d3.select('#heatmaps').call(zoom);

            drawSwsChart(selected_subjects);
            renderRemovedSubjects(removedSubjects);

            createRatingsHeatmap(width_of_field, height_of_field, 400);
            createTimeoverlapHeatmap(width_of_field, height_of_field, 400);
         } else {
            alert("You do not have marked any subjets. Please go back and select some!")
        }
    </script>
  </body>
</html>
