<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Select Subjects</title>
    <link rel="stylesheet" href="select-page.css"/>
    <link rel="stylesheet" href="../scripts/bootstrap/bootstrap.min.css"/>
    <!--<script type="text/javascript" src="../scripts/bootstrap/bootstrap.bundle.min.js"></script>-->
    <script src="d3.js"></script>
    <script type="text/javascript" src="../data/studyprograms.js"></script>
    <script type="text/javascript" src="select-page.js"></script>

</head>
<body>
    <main id="content">
        <svg width="1400" height="1060"></svg>
    </main>
    <nav id="side-menu">
        <div class="card">
            <div class="card-header">
                <h2>
                    Step 1: Mark courses of interest
                </h2>
            </div>
            <div class="card-body">
                <div>
                    <span>Show only:</span>
                    <div id="radial-filter">

                    </div>
                </div>
            </div>
        </div>
    </nav>
    <div id="toggle-button" onclick="toggleNavigation()">
        toggle
    </div>
    <script type="text/javascript" src="radial-tree.js"></script>
    <script>
        let selected_studyprogram = null;

        for (let program of studyprograms) {
            if (program['name'] === "Angewandte Informatik, Master of Science, PO 2012") {
                console.log(program.categories)
                if (selected_studyprogram == null) {
                    selected_studyprogram = program;
                    console.log(program.categories)
                } else {
                    selected_studyprogram = merge_studyprogram_semesters(program, selected_studyprogram)
                }
                console.log(selected_studyprogram);
            }
        }

        let colormap = {};
        let stats_names = [];
        let type_filter_settings = new Set();
        let colors = d3.schemeSet3;
        let originalNavigationWidth = document.getElementById('side-menu').getAttribute("width");

        //mapping colors to attributes colors
        for (let key in selected_studyprogram.stats) {
            stats_names.push(key)
        }
        //initializing colormap and settings for filtering
        for ( let index = 0; index < stats_names.length; index++) {
            colormap[stats_names[index]] = colors[index];
            type_filter_settings.add(stats_names[index])
        }

        stats_names.push("SoSe 2019");
        stats_names.push("WiSe 2018/19");
        type_filter_settings.add("SoSe 2019");
        type_filter_settings.add("WiSe 2018/19");

        function toggleNavigation() {
            console.log("toggle");
            let navMenu = document.getElementById('side-menu');
            navMenu.style.setProperty("display", (navMenu.style.display === "none") ? "block":"none");
        }
        function onLegendElementClick(d) {
            //toggle setting for filter
            if (type_filter_settings.has(d)) {
                type_filter_settings.delete(d)
            } else {
                type_filter_settings.add(d)
            }
            //let root = tree(d3.hierarchy(selected_studyprogram, children_func));
            renderLegend();
            RadialTree.draw(root)
        }

        function renderLegend() {
            let divs = d3.select('#radial-filter')
                .selectAll('.filter')
                .data(stats_names, d => d);

            let divsEnter = divs
                .enter()
                .append('div')
                .attr("class","filter")
                .on("click", (d) => {
                    onLegendElementClick(d)
                });


            let checkboxes = divsEnter
                .append('input')
                .attr("type","checkbox");

            d3.select('#radial-filter').selectAll('input')
                .property("checked", (d) => {
                    console.log(type_filter_settings.has(d));
                    return type_filter_settings.has(d);
                });

            let types = divsEnter
                .append("span")
                .attr("class", "color-value");

            types.merge(types)
                .text((d) => d)
                .style("background-color", (d) => colormap[d]);
        }

        function merge_studyprogram_semesters(program_semester1, program_semester2) {
            //merge categories
            program = program_semester1;
            program.categories = program_semester1.categories.concat(program_semester2.categories);

            // merge statistics
            new_stats = program_semester2.stats;
            for (key in program.stats) {
                if (new_stats.hasOwnProperty(key)) {
                    new_stats[key] += program.stats[key];
                } else {
                    new_stats[key] = program.stats[key];
                }
            }

            return program;
        }

        // start drawing the tree
        renderLegend();
        let root = RadialTree.init(selected_studyprogram, colormap, type_filter_settings);
        RadialTree.draw(root);


    </script>
</body>
</html>
